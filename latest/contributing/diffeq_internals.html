<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>The DiffEq Internals · DifferentialEquations.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/default.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Ubuntu+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="../assets/documenter.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../assets/documenter.js"></script></head><body><nav class="toc"><h1>DifferentialEquations.jl</h1><form class="search" action="../search.html"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../index.html">Home</a></li><li><span class="toctext">Contributor Guide</span><ul><li><a class="toctext" href="contributors_guide.html">Contributor&#39;s Guide</a></li><li><a class="toctext" href="adding_algorithms.html">Adding Algorithms</a></li><li><a class="toctext" href="defining_problems.html">Developing A New Problem</a></li><li class="current"><a class="toctext" href="diffeq_internals.html">The DiffEq Internals</a><ul class="internal"><li><a class="toctext" href="#Developing-New-Solver-Algorithms-1">Developing New Solver Algorithms</a></li><li><a class="toctext" href="#Extras-1">Extras</a></li></ul></li></ul></li><li><span class="toctext">Internal Documentation</span><ul><li><a class="toctext" href="../internals/fem_tools.html">Internal Finite Element Tools</a></li><li><a class="toctext" href="../internals/extras.html">Extra Functions</a></li><li><a class="toctext" href="../internals/solver_helpers.html">Solver Extras</a></li><li><a class="toctext" href="../internals/notes_on_algorithms.html">Notes on Algorithms</a></li><li><a class="toctext" href="../internals/tableaus.html">ODE Tableaus</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li>Contributor Guide</li><li><a href="diffeq_internals.html">The DiffEq Internals</a></li></ul><a class="edit-page" href="https://github.com/JuliaDiffEq/DiffEqDevDocs.jl/tree/f3f48bc1b5326b0e3f797f99dd8bcb30e2b5ac93/docs/src/contributing/diffeq_internals.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/></header><h1><a class="nav-anchor" id="The-DiffEq-Internals-1" href="#The-DiffEq-Internals-1">The DiffEq Internals</a></h1><p>The DiffEq solvers, OrdineryDiffEq, StochasticDiffEq, FiniteElementDiffEq, etc. all follow a similar scheme which leads to rapid development and high performance. This portion of the documentation explains how the algorithms are written.</p><h2><a class="nav-anchor" id="Developing-New-Solver-Algorithms-1" href="#Developing-New-Solver-Algorithms-1">Developing New Solver Algorithms</a></h2><p>The easiest way to get started would be to add new solver algorithms. This is a pretty simple task as there are tools which put you right into the &quot;hot loop&quot;. For example, take a look at the ODE solver code. The mode <code>solve(::ODEProblem,::OrdinaryDiffEqAlgorithm)</code> is glue code to a bunch of solver algorithms. The algorithms which are coded in DifferentialEquations.jl can be found in ode_integrators.jl. For example, take a look at the Midpoint method&#39;s implementation (without the function header):</p><pre><code class="language-julia">  @ode_preamble
  halfdt::tType = dt/2
  @inbounds for T in Ts
    while t &lt; T
      @ode_loopheader
      u = u + dt.*f(t+halfdt,u+halfdt.*f(t,u))
      @ode_numberloopfooter
    end
  end
  return u,t,timeseries,ts</code></pre><p>The available items are all unloaded from the <code>integrator</code> in the <code>@ode_preamble</code>. <code>@ode_loopheader</code> and <code>@ode_loopfooter</code> macros are for exiting at max iterations, and plugging into the Juno progressbar. These are all defined using the <code>@def</code> macro (they essentially copy-paste the code from the line which says <code>@def ode_loopheader begin ... end</code>). Note that the loopfooter code takes care of the code for doing the adaptive timestepping. All that is required for the adaptivity is that the algorithm computes an error estimate <code>EEst</code> each time, save the value <code>utmp</code> to be what will replace <code>u</code> if the step is not rejected. If implicit solving is needed (via NLsolve), add the algorithm&#39;s symbol to <code>isimplicit</code> and the conditional dependency will be supplied. Note that you may need more function arguments. Use another method as a template.</p><p>It&#39;s that quick! Lastly, add your method to the convergence tests in the appropriate /test file.   Feel free to implement any interesting or educational algorithm: they don&#39;t have to be the fastest and it is always is useful to have such algorithms (like Simpson&#39;s method) available for demonstration purposes.</p><p>Adding algorithms to the other problems is very similar.</p><h2><a class="nav-anchor" id="Extras-1" href="#Extras-1">Extras</a></h2><p>If the method is a FSAL method then it needs to be set via <code>isfsal</code> and <code>fsalfirst</code> should be defined before the loop, with <code>fsallast</code> what&#39;s pushed up to <code>fsalfirst</code> upon a successful step. See <code>:DP5</code> for an example.</p><p>It&#39;s usually wise to dispatch onto Number separately since that uses <code>f(t,u)</code> instead of <code>f(t,u,du)</code>. The dispatch is chosen by setting the <code>uType</code> and <code>rateType</code>, usually to either <code>&lt;:Number</code> or <code>&lt;:AbstractArray</code> (though they should be the same).</p><p>If tests fail due to units (i.e. Unitful), don&#39;t worry. I would be willing to fix that up. To do so, you have to make sure you keep separate your <code>rateType</code>s and your <code>uType</code>s since the rates from <code>f</code> will have units of <code>u</code> but divided by a unit of time. If you simply try to write these into <code>u</code>, the units part will fail (normally you have to multiply by a <span>$dt$</span>).</p><footer><hr/><a class="previous" href="defining_problems.html"><span class="direction">Previous</span><span class="title">Developing A New Problem</span></a><a class="next" href="../internals/fem_tools.html"><span class="direction">Next</span><span class="title">Internal Finite Element Tools</span></a></footer></article></body></html>
